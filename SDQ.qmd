---
title: "SDQ"
author: "Honestly 90% Cristin in the end I expect..."
format: docx
editor: visual
---

# SDQ scoring

The Strengths and Difficulties Questionnaire (SDQ) is a brief behavioral screening questionnaire about 2-17 year-olds. It exists in several versions to meet the needs of researchers, clinicians and educators. Each version includes between one and three of the following components: 1) Items on psychological attributes; 2) An impact supplement; 3) Follow-up questions.

\
An **increase** in score indicates a negative outcome. Published cut-points are available for both total score and sub-scales and a range of normative data distributions are also available.

```{r, reading_in_data}
#| echo: false
#| warning: false
#| message: false
#| include: false
library(readr)
library(tidyverse)
library(janitor)

#sdq question lookup table to rename columns
sdq_24_questions <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/sdq-24-scoring.csv")
sdq_410_questions <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/sdq-410-scoring.csv")
sdq_1117_questions <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/sdq-1117-scoring.csv")
sdq_1117_self_questions <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/sdq-1117-self-scoring.csv")
# dealing with crazy header rows
sdq_P24_raw <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ P2-4.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE) # sdq_P24_raw <- read_csv("/Users/tristan/CWS Dropbox/Tristan Burgess/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ P2-4.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE,show_col_types = FALSE) 
h1 <- unlist(sdq_P24_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(sdq_P24_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
sdq_P24 <- sdq_P24_raw[-c(1, 2), ]
names(sdq_P24) <- new_names
sdq_P24 <- sdq_P24 %>%
  select(where(~ !all(is.na(.))))

# NOTE: All items appear present and correct, but three are in an odd column order, relocated to the start. Impact items have a score column, but it's all NAs. The impact items have a lot of missing data.

# dealing with crazy header rows
sdq_P410_raw <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ P4-10.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE) 
#sdq_P410_raw <- read_csv("/Users/tristan/CWS Dropbox/Tristan Burgess/CYBHI Project/Data#/eInsight Exports/Individual Assessments/SDQ P4-10.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE,show_col_types = FALSE) 
h1 <- unlist(sdq_P410_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(sdq_P410_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
sdq_P410 <- sdq_P410_raw[-c(1, 2), ]
names(sdq_P410) <- new_names
sdq_P410 <- sdq_P410 %>%
  select(where(~ !all(is.na(.))))

# NOTE: All items appear present and correct and they're even in order! Sadly impact variables appear to be missing.

# dealing with crazy header rows
sdq_P1117_raw <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ P11-17.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE) 
#sdq_P1117_raw <- read_csv("/Users/tristan/CWS Dropbox/Tristan Burgess/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ P11-17.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE,show_col_types = FALSE) 
h1 <- unlist(sdq_P1117_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(sdq_P1117_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
sdq_P1117 <- sdq_P1117_raw[-c(1, 2), ]
names(sdq_P1117) <- new_names
sdq_P1117 <- sdq_P1117 %>%
  select(where(~ !all(is.na(.))))

#NOTE: All score variables present, seemingly random column order. Impact variables present, but no score columns for these.

# dealing with crazy header rows
sdq_S1117_raw <- read_csv("/Users/cristin/CWS Dropbox/Cristin Young/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ S11-17.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE) 
#sdq_S1117_raw <- read_csv("/Users/tristan/CWS Dropbox/Tristan Burgess/CYBHI Project/Data/eInsight Exports/Individual Assessments/SDQ S11-17.csv", na = c("-", "", "NA", "N/A"), col_names = FALSE,show_col_types = FALSE) 
h1 <- unlist(sdq_S1117_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(sdq_S1117_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
sdq_S1117 <- sdq_S1117_raw[-c(1, 2), ]
names(sdq_S1117) <- new_names
sdq_S1117 <- sdq_S1117 %>%
  select(where(~ !all(is.na(.))))

# NOTE: All items appear present and correct and they're even in order! Impact variables present and have score columns but the score columns are all NAs.
```

The following data answers the follow study sub-questions:

-   **3.11: "**To what extent did parents/caregivers report reductions in disruptive behaviors after receiving the intervention?"

-   **3.16: "**To what extent did children/youth report improvements in coping/handling overall difficulties after the intervention?**"**

## Functions to score SDQ datasets

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
score_sdq <- function(df, lookup, cutoffs_total, cutoffs_externalizing, rev_items,
                      exclude_items, externalizing_items) {
  
  # 1. Create standardized new column names, e.g., q1_itemname_score
  lookup <- lookup %>%
    mutate(new_name = paste0("q", item, "_", column_name))
  
  # 2. Metadata columns vs SDQ columns
  meta_cols <- setdiff(names(df), lookup$column_name)
  
  # 3. Reorder and rename
  df <- df %>%
    dplyr::select(all_of(meta_cols), all_of(lookup$column_name)) %>%
    rename_with(~ lookup$new_name, all_of(lookup$column_name)) %>%
    mutate(across(all_of(lookup$new_name), as.numeric))
  
  # 4. Handle reverse coding
  included <- lookup %>% filter(item %in% 1:25, !item %in% exclude_items)
  
  rev_cols <- included$new_name[included$item %in% rev_items]
  
  df <- df %>%
    mutate(across(all_of(rev_cols),
                  ~ ifelse(is.na(.x), NA, 2 - .x), # 0–2 => 2–0
                  .names = "{.col}_rev"))
  
  # 5. Build effective scoring set (rev where needed)
  effective_cols <- ifelse(included$new_name %in% rev_cols,
                           paste0(included$new_name, "_rev"),
                           included$new_name)

  # 6. Total score
  df <- df %>%
    mutate(
      missing_count_total = rowSums(is.na(across(all_of(included$new_name)))),
      total_score = rowSums(across(all_of(effective_cols)), na.rm = TRUE),
      total_score = ifelse(missing_count_total >= 3, NA_real_, total_score),
      cut_off_band = case_when(
        total_score >= cutoffs_total$close_min  & 
          total_score <= cutoffs_total$close_max ~ "close to average",
        total_score >= cutoffs_total$slight_min & 
          total_score <= cutoffs_total$slight_max ~ "slightly raised/lowered",
        total_score >= cutoffs_total$high_min   & 
          total_score <= cutoffs_total$high_max   ~ "high/low",
        total_score >= cutoffs_total$very_min   & 
          total_score <= cutoffs_total$very_max   ~ "very high/low",
        TRUE ~ NA_character_
      )
    )
  
  # 7. Externalizing score
  ext_lookup <- lookup %>% filter(item %in% externalizing_items)
  ext_effective_cols <- ifelse(ext_lookup$new_name %in% rev_cols,
                               paste0(ext_lookup$new_name, "_rev"),
                               ext_lookup$new_name)
  
  df <- df %>%
    mutate(
      missing_count_externalizing = rowSums(is.na(across(all_of(ext_lookup$new_name)))),
      externalizing_score = rowSums(across(all_of(ext_effective_cols)), na.rm = TRUE),
      externalizing_score = ifelse(missing_count_externalizing >= 3,
                                   NA_real_, externalizing_score),
      externalizing_band = case_when(
        externalizing_score >= cutoffs_externalizing$close_min & 
          externalizing_score <= cutoffs_externalizing$close_max ~ "close to average",
        externalizing_score >= cutoffs_externalizing$slight_min & 
          externalizing_score <= cutoffs_externalizing$slight_max ~ "slightly raised/lowered",
        externalizing_score >= cutoffs_externalizing$high_min & 
          externalizing_score <= cutoffs_externalizing$high_max ~ "high/low",
        externalizing_score >= cutoffs_externalizing$very_min & 
          externalizing_score <= cutoffs_externalizing$very_max ~ "very high/low",
        TRUE ~ NA_character_
      )
    )
  
  return(df)
}
```

```{r, defining_params_and_bands}
#| echo: false
#| warning: false
#| message: false
#| include: false

# Reverse-coded items
rev_items <- c(7, 11, 14, 21, 25)

# Excluded from total scoring
exclude_items <- c(1, 4, 9, 17, 20)

# Externalizing items
externalizing_items <- c(2, 5, 7, 10, 12, 15, 18, 21, 22, 25)

# cutoff bands
cutoffs_total_P24 <- list(
  close_min = 0, close_max = 12,
  slight_min = 13, slight_max = 15,
  high_min = 16, high_max = 18,
  very_min = 19, very_max = 40
)

cutoffs_externalizing_P24 <- list(
  close_min = 0, close_max = 8,
  slight_min = 9, slight_max = 11,
  high_min = 12, high_max = 13,
  very_min = 14, very_max = 20
)

cutoffs_total_P410 <- list(
  close_min = 0, close_max = 13,
  slight_min = 14, slight_max = 16,
  high_min = 17, high_max = 19,
  very_min = 20, very_max = 40
)

cutoffs_externalizing_P410 <- list(
  close_min = 0, close_max = 8,
  slight_min = 9, slight_max = 10,
  high_min = 11, high_max = 12,
  very_min = 13, very_max = 20
)

cutoffs_total_P1117 <- list(
  close_min = 0, close_max = 13,
  slight_min = 14, slight_max = 16,
  high_min = 17, high_max = 19,
  very_min = 20, very_max = 40
)

cutoffs_externalizing_P1117 <- list(
  close_min = 0, close_max = 8,
  slight_min = 9, slight_max = 10,
  high_min = 11, high_max = 12,
  very_min = 13, very_max = 20
)

cutoffs_total_S1117 <- list(
  close_min = 0, close_max = 14,
  slight_min = 15, slight_max = 17,
  high_min = 18, high_max = 19,
  very_min = 20, very_max = 40
)

cutoffs_externalizing_S1117 <- list(
  close_min = 0, close_max = 8,
  slight_min = 9, slight_max = 10,
  high_min = 11, high_max = 12,
  very_min = 13, very_max = 20
)
```

```{r, calculating_scores}
#| echo: false
#| warning: false
#| message: false
#| include: false
sdq_P24 <- score_sdq(sdq_P24, sdq_24_questions,
                     cutoffs_total_P24, cutoffs_externalizing_P24,
                     rev_items, exclude_items,
                     externalizing_items)

sdq_P410 <- score_sdq(sdq_P410, sdq_410_questions,
                      cutoffs_total_P410, cutoffs_externalizing_P410, 
                      rev_items, exclude_items,
                      externalizing_items)

sdq_P1117 <- score_sdq(sdq_P1117, sdq_1117_questions,
                       cutoffs_total_P1117, cutoffs_externalizing_P1117,
                       rev_items, exclude_items,
                       externalizing_items)

sdq_S1117 <- score_sdq(sdq_S1117, sdq_1117_self_questions,
                       cutoffs_total_S1117, cutoffs_externalizing_S1117,
                       rev_items, exclude_items,
                       externalizing_items)
```

```{r, creating_summary_tables}
#| echo: false
#| warning: false
#| message: false
#| include: false
analyze_sdq <- function(df, label = NULL) {
  
  message("---- Running analysis for: ", label, " ----")
  
  # 1. Histograms
  print(hist(df$total_score, 
             main = paste("Total Score:", label),
             xlab = "Total Score", col = "steelblue"))
  
  print(hist(df$externalizing_score, 
             main = paste("Externalizing Score:", label),
             xlab = "Externalizing Score", col = "steelblue"))
  
  # 2. Min & max
  print(paste("Total Min:", min(df$total_score, na.rm = TRUE)))
  print(paste("Total Max:", max(df$total_score, na.rm = TRUE)))
  print(paste("Externalizing Min:", min(df$externalizing_score, na.rm = TRUE)))
  print(paste("Externalizing Max:", max(df$externalizing_score, na.rm = TRUE)))

    # 3. Extract key columns
  scores <- df %>%
    select(client_system_id, collection, date_completed, total_score, 
           externalizing_score, cut_off_band, externalizing_band)
  
  # 4. Pair by client
  paired <- scores %>%
    mutate(date_completed = as.Date(date_completed)) %>% 
    group_by(client_system_id) %>%
    arrange(date_completed, .by_group = TRUE) %>%
    summarise(
      n_assessments = n(),
      initial_date  = first(date_completed),
      follow_up_date  = if_else(n_assessments >= 2, 
                                last(date_completed), as.Date(NA)),
      initial_total = first(total_score),
      follow_up_total = if_else(n_assessments >= 2, 
                                last(total_score), NA_real_),
      initial_ext = first(externalizing_score),
      follow_up_ext = if_else(n_assessments >= 2, last(externalizing_score), NA_real_)
    ) %>%
    ungroup() %>% 
    filter(!is.na(follow_up_date)) %>% 
    mutate(
      positive_outcome_total = ifelse(follow_up_total < initial_total, 1, 0), 
      positive_outcome_ext = ifelse(follow_up_ext < initial_ext, 1, 0), 
      initial_quarter = paste0("Q", quarter(initial_date), " ", year(initial_date)),
      follow_up_quarter = paste0("Q", quarter(follow_up_date), " ", year(follow_up_date))
    )
  
  # 5. Summary table: TOTAL
  tab_total <- paired %>% 
    filter(!is.na(positive_outcome_total)) %>% 
    tabyl(follow_up_quarter, positive_outcome_total) %>% 
    adorn_totals("row") %>% 
    adorn_percentages("row") %>%
    adorn_pct_formatting(digits = 0) %>%
    adorn_ns()
  
   # 6. Summary table: EXTERNALIZING
  tab_ext <- paired %>% 
    filter(!is.na(positive_outcome_ext)) %>% 
    tabyl(follow_up_quarter, positive_outcome_ext) %>% 
    adorn_totals("row") %>% 
    adorn_percentages("row") %>%
    adorn_pct_formatting(digits = 0) %>%
    adorn_ns()
  
  # 7. Summary table: TOTAL - NOT BY QUARTER
  tab_total_overall <- paired %>% 
    filter(!is.na(positive_outcome_total)) %>% 
    tabyl(positive_outcome_total) %>% 
    adorn_pct_formatting(digits = 0) 
  
  # 8. Summary table: EXTERNALIZING - NOT BY QUARTER
  tab_ext_overall <- paired %>% 
    filter(!is.na(positive_outcome_ext)) %>% 
    tabyl(positive_outcome_ext) %>% 
    adorn_pct_formatting(digits = 0) 
  
  # print both tabs
  message("---- Total score outcomes by follow-up quarter ----")
  print(tab_total)
  message("---- Externalizing outcomes by follow-up quarter ----")
  print(tab_ext)
  message("---- Total score outcomes ----")
  print(tab_total_overall)
  message("---- Externalizing outcomes score ----")
  print(tab_ext_overall)
  
  return(list(
    paired = paired,
    summary_total = tab_total,
    summary_externalizing = tab_ext
  ))
}
```

## Scoring the datasets

```{r, running_for_each_df}
#| echo: false
#| warning: false
#| message: false
library(patchwork)
# run analysis for each dataset 
res_P24   <- analyze_sdq(sdq_P24,   label = "Parent SDQ (2–4)")
res_P24$summary_total
res_P24$summary_externalizing

res_P410  <- analyze_sdq(sdq_P410,  label = "Parent SDQ (4–10)")
res_P410$summary_total
res_P410$summary_externalizing

res_P1117 <- analyze_sdq(sdq_P1117, label = "Parent SDQ (11–17)")
res_P1117$summary_total
res_P1117$summary_externalizing

res_S1117 <- analyze_sdq(sdq_S1117, label = "Self SDQ (11–17)")
res_S1117$summary_total
res_S1117$summary_externalizing

sdq_list <- list(res_P24, res_P410, res_P1117, res_S1117)

df_from_lists <- imap_dfr(sdq_list, ~ {
  .x[[1]] %>%                      # first tibble inside each list
    transmute(
      subgroup = .y,               # use the list name as subgroup (pop_a, pop_b, etc.)
      initial_total  = initial_total,
      follow_up_total = follow_up_total,
      initial_ext = initial_ext,
      follow_up_ext = follow_up_ext
    )
})
```

```{r, plotting_total}
#| echo: false
#| warning: false
#| message: false
# Pivot to long format
sdq_long_total <- df_from_lists %>%
  pivot_longer(
    cols = c(initial_total, follow_up_total),
    names_to = "timepoint",
    values_to = "value"
  )

# Rename and order subgroups
sdq_long_total$subgroup <- recode(sdq_long_total$subgroup,
                           "1" = "SDQ Parent (2-4)",
                           "2" = "SDQ Parent (4-10)",
                           "3" = "SDQ Parent (11-17)",
                           "4" = "SDQ Self (11-17)")

sdq_long_total$subgroup <- factor(sdq_long_total$subgroup, levels = c(
  "SDQ Parent (2-4)", "SDQ Parent (4-10)", "SDQ Parent (11-17)", "SDQ Self (11-17)"))

sdq_long_total$timepoint <- factor(sdq_long_total$timepoint, levels = c("initial_total", "follow_up_total"))

# summary stats
summary_stats <- sdq_long_total %>% 
  group_by(subgroup, timepoint) %>% 
  summarise(
    mean_score = mean(value, na.rm = TRUE), 
    median_score = median(value, na.rm = TRUE),
    sd_score = sd(value, na.rm = TRUE), 
    n = sum(!is.na(value))
  )

summary_stats
#clipr::write_clip(summary_stats)

# Mean difference table
mean_differences <- sdq_long_total %>%
  group_by(subgroup, timepoint) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  pivot_wider(names_from = timepoint, values_from = mean_value) %>%
  mutate(difference = follow_up_total - initial_total)

gap_table <- ggplot(mean_differences, aes(x = 1, y = subgroup)) +
  geom_text(aes(label = round(difference, 2)), size = 3, hjust = 0) +
  theme_void() +
  labs(title = "Mean Diff.\n(Follow-up - Initial)\ndecrease indicates\npositive outcome") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 7, margin = margin(t = 8, b = -15)),
    axis.text.y = element_blank(),
    plot.margin = margin(t = 5, b = -5, l = 5, r = 5)
  ) +
  scale_y_discrete(limits = levels(sdq_long_total$subgroup))

# Ridgeline plot with top legend and no chart title
ridge_plot <- ggplot(sdq_long_total, aes(x = value, y = subgroup, fill = timepoint)) +
  geom_density_ridges(
    aes(color = timepoint),
    alpha = 0.7,
    scale = 1.2,
    rel_min_height = 0.01
  ) +
  scale_fill_manual(
    values = c("initial_total" = "#8A8C8E", "follow_up_total" = "#BBDB49"),
    breaks = c("initial_total", "follow_up_total"),
    labels = c("Initial", "Follow-up")
  ) +
  scale_color_manual(
  values = c("initial_total" = "#8A8C8E", "follow_up_total" = "#BBDB49"),
    breaks = c("initial_total", "follow_up_total"),
    labels = c("Initial", "Follow-up")
  ) +
  labs(x = "SDQ total score", 
       y = NULL, 
       title = "Distribution of initial and follow-up total scores by subgroup, SDQ") +
  theme_ridges(font_family = "Arial") +
  theme(
    axis.title.x = element_text(size = 9, hjust = 0),
    axis.text.y = element_text(size = 9, hjust = 1),
    axis.text.x = element_text(size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.box.margin = margin(b = -5),
    plot.margin = margin(5, 5, 5, 5)
  )

# Combine with patchwork without title/subtitle
final_plot <- (ridge_plot | gap_table) +
  plot_layout(widths = c(5, 1)) +
  plot_annotation(title = NULL, subtitle = NULL)

# Display final plot
final_plot
```

```{r, plotting_ext}
#| echo: false
#| warning: false
#| message: false
# Pivot to long format
sdq_long_ext <- df_from_lists %>%
  pivot_longer(
    cols = c(initial_ext, follow_up_ext),
    names_to = "timepoint",
    values_to = "value"
  )

# Rename and order subgroups
sdq_long_ext$subgroup <- recode(sdq_long_ext$subgroup,
                           "1" = "SDQ Parent (2-4)",
                           "2" = "SDQ Parent (4-10)",
                           "3" = "SDQ Parent (11-17)",
                           "4" = "SDQ Self (11-17)")

sdq_long_ext$subgroup <- factor(sdq_long_ext$subgroup, levels = c(
  "SDQ Parent (2-4)", "SDQ Parent (4-10)", "SDQ Parent (11-17)", "SDQ Self (11-17)"))

sdq_long_ext$timepoint <- factor(sdq_long_ext$timepoint, levels = c("initial_ext", "follow_up_ext"))

# summary stats
summary_stats <- sdq_long_ext %>% 
  group_by(subgroup, timepoint) %>% 
  summarise(
    mean_score = mean(value, na.rm = TRUE), 
    median_score = median(value, na.rm = TRUE),
    sd_score = sd(value, na.rm = TRUE), 
    n = sum(!is.na(value))
  )

summary_stats
#clipr::write_clip(summary_stats)

# Mean difference table
mean_differences <- sdq_long_ext %>%
  group_by(subgroup, timepoint) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  pivot_wider(names_from = timepoint, values_from = mean_value) %>%
  mutate(difference = follow_up_ext - initial_ext)

gap_table <- ggplot(mean_differences, aes(x = 1, y = subgroup)) +
  geom_text(aes(label = round(difference, 2)), size = 3, hjust = 0) +
  theme_void() +
  labs(title = "Mean Diff.\n(Follow-up - Initial)\ndecrease indicates\npositive outcome") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 7, margin = margin(t = 8, b = -15)),
    axis.text.y = element_blank(),
    plot.margin = margin(t = 5, b = -5, l = 5, r = 5)
  ) +
  scale_y_discrete(limits = levels(sdq_long_ext$subgroup))

# Ridgeline plot with top legend and no chart title
ridge_plot <- ggplot(sdq_long_ext, aes(x = value, y = subgroup, fill = timepoint)) +
  geom_density_ridges(
    aes(color = timepoint),
    alpha = 0.7,
    scale = 1.2,
    rel_min_height = 0.01
  ) +
  scale_fill_manual(
    values = c("initial_ext" = "#8A8C8E", "follow_up_ext" = "#BBDB49"),
    breaks = c("initial_ext", "follow_up_ext"),
    labels = c("Initial", "Follow-up")
  ) +
  scale_color_manual(
    values = c("initial_ext" = "#8A8C8E", "follow_up_ext" = "#BBDB49"),
    breaks = c("initial_ext", "follow_up_ext"),
    labels = c("Initial", "Follow-up")
  ) +
  labs(x = "SDQ externalizing score", 
       y = NULL, 
       title = "Distribution of initial and follow-up externalizing scores by subgroup, SDQ") +
  theme_ridges(font_family = "Arial") +
  theme(
    axis.title.x = element_text(size = 9, hjust = 0),
    axis.text.y = element_text(size = 9, hjust = 1),
    axis.text.x = element_text(size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.box.margin = margin(b = -5),
    plot.margin = margin(5, 5, 5, 5)
  )

# Combine with patchwork without title/subtitle
final_plot <- (ridge_plot | gap_table) +
  plot_layout(widths = c(5, 1)) +
  plot_annotation(title = NULL, subtitle = NULL)

# Display final plot
final_plot
```

## Reductions in disruptive behaviors (SDQ)

### 2-4 (Provider)

**‘Internalising’ and ‘externalising’ scores**: The internalising score ranges from 0 to 20 and is the sum of the emotional and peer difficulties scales. The externalising score ranges from 0 to 20 and is the sum of the conduct and hyperactivity scales. We will be using the externalising score for this KPI.

**Calculation:** Hyperactivity scale (2, 10, 15, 21, 25) + conduct scale (5, 7, 12, 18, 22) Cut off bands

## Improvements in coping and handling overall difficulties (SDQ)

### 2-4 (Provider)

**Scoring:** In most respects, the 2-4 year old version of the SDQ is scored in an identical way to the 4-17 year old version of the SDQ, and we therefore suggest that you start by reading those instructions. The only differences are:

-   The wording of two items on the ‘conduct’ scales is markedly different in the questionnaire for 2-4 year olds compared to the questionnaire for 4-17 (but the scoring stays the same). One further hyperactivity item is softened slightly in the 2-4 year old questionnaire. These three items are highlighted in Table 1.

-   Large population-based surveys in the UK suggest slightly different population norms for 2-4 year olds compared to older children. The banding of SDQ scores for the 2-4 year old version is shown in Table 3.

**Total difficulties score**: This is generated by summing scores from all the scales except the prosocial scale. The resultant score ranges from 0 to 40, and is counted as missing if one of the 4 component scores is missing.

don't sum: 1, 4, 9, 17, 20

reverse code: 7, 21, 25, 11, 14

**Assumptions:** used LAST follow-up if 2+ assessments exist; filtered out NA's from follow-up date and positive outcome variable before calculating %.

#### Cut off bands

We used the SDQ distribution data to propose the following banding of SDQ scores for 2-4 year olds. We have sought cut-points such that around 80% of children are ‘close to average’, 12% ‘slightly raised’, 4% ‘high’ and 4% ‘very high’ (or, for the prosocial scale, 80% are close to average, 12% ‘slightly lowered’, 4% ‘low’ and 4% ‘very low’).

Similar cut-points were observed for parent SDQs collected in a smaller American sample (N=307) of 2-4 year olds, and for parent SDQs collected in the English ‘Mental Health of Children And Young People, 2017’ study.

|   | Close to average | Slightly raised (/slightly lowered) | High (/Low) | Very high (/very low) |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Parented completed SDQ total score | 0-12 | 13-15 | 16-18 | 19-40 |
| Teacher completed SDQ total score | 0-10 | 11-14 | 15-17 | 18-40 |

### 4-10 (Provider)

**Scoring:** The 25 items in the SDQ comprise 5 scales of 5 items each. It is usually easiest to score all 5 scales first before working out the total difficulties score. ‘Somewhat True’ is always scored as 1, but the scoring of ‘Not True’ and ‘Certainly True’ varies with the item, as shown below scale by scale. For each of the 5 scales the score can range from 0 to 10 if all items were completed. These scores can be scaled up pro-rata if at least 3 items were completed, e.g. a score of 4 based on 3 completed items can be scaled up to a score of 7 (6.67 rounded up) for 5 items.

**Total difficulties score**: This is generated by summing scores from all the scales except the prosocial scale. The resultant score ranges from 0 to 40, and is counted as missing of one of the 4 component scores is missing.

don't sum: 1, 4, 9, 17, 20

reverse code: 7, 21, 25, 11, 14

**Assumptions:** used LAST follow-up if 2+ assessments exist; filtered out NA's from follow-up date and positive outcome variable before calculating %.

#### Cut off bands

|   | Close to average | Slightly raised (/slightly lowered) | High (/Low) | Very high (/very low) |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Parented completed SDQ total score | 0-13 | 14-16 | 17-19 | 20-40 |
| Teacher completed SDQ total score | 0-11 | 12-15 | 16-18 | 19-40 |
| Self completed SDQ total score | 0-14 | 15-17 | 18-19 | 20-40 |

### 11-17 (Provider)

**Scoring:** The 25 items in the SDQ comprise 5 scales of 5 items each. It is usually easiest to score all 5 scales first before working out the total difficulties score. ‘Somewhat True’ is always scored as 1, but the scoring of ‘Not True’ and ‘Certainly True’ varies with the item, as shown below scale by scale. For each of the 5 scales the score can range from 0 to 10 if all items were completed. These scores can be scaled up pro-rata if at least 3 items were completed, e.g. a score of 4 based on 3 completed items can be scaled up to a score of 7 (6.67 rounded up) for 5 items.

**Total difficulties score**: This is generated by summing scores from all the scales except the prosocial scale. The resultant score ranges from 0 to 40, and is counted as missing of one of the 4 component scores is missing.

don't sum: 1, 4, 9, 17, 20

reverse code: 7, 21, 25, 11, 14

**Assumptions:** used LAST follow-up if 2+ assessments exist; filtered out NA's from follow-up date and positive outcome variable before calculating %.

#### Cut off bands

|   | Close to average | Slightly raised (/slightly lowered) | High (/Low) | Very high (/very low) |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Parented completed SDQ total score | 0-13 | 14-16 | 17-19 | 20-40 |
| Teacher completed SDQ total score | 0-11 | 12-15 | 16-18 | 19-40 |
| Self completed SDQ total score | 0-14 | 15-17 | 18-19 | 20-40 |

### 11-17 (Self)

**Scoring:** The 25 items in the SDQ comprise 5 scales of 5 items each. It is usually easiest to score all 5 scales first before working out the total difficulties score. ‘Somewhat True’ is always scored as 1, but the scoring of ‘Not True’ and ‘Certainly True’ varies with the item, as shown below scale by scale. For each of the 5 scales the score can range from 0 to 10 if all items were completed. These scores can be scaled up pro-rata if at least 3 items were completed, e.g. a score of 4 based on 3 completed items can be scaled up to a score of 7 (6.67 rounded up) for 5 items.

**Total difficulties score**: This is generated by summing scores from all the scales except the prosocial scale. The resultant score ranges from 0 to 40, and is counted as missing of one of the 4 component scores is missing.

don't sum: 1, 4, 9, 17, 20

reverse code: 7, 21, 25, 11, 14

**Assumptions:** used LAST follow-up if 2+ assessments exist; filtered out NA's from follow-up date and positive outcome variable before calculating %.

#### Cut off bands

|   | Close to average | Slightly raised (/slightly lowered) | High (/Low) | Very high (/very low) |
|---------------|:-------------:|:-------------:|:-------------:|:-------------:|
| Parented completed SDQ total score | 0-13 | 14-16 | 17-19 | 20-40 |
| Teacher completed SDQ total score | 0-11 | 12-15 | 16-18 | 19-40 |
| Self completed SDQ total score | 0-14 | 15-17 | 18-19 | 20-40 |
