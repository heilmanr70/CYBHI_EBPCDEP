---
title: "NOMS_Visuals"
output: html_document
---

#each NOMS assessment topic area (except for the NOMS sub-scale used for evaluation study question 2.00) will have two visuals, which will show: 1) the averages and the distributions at both initial and discharge time points, and 2) the percentages of those who selected ratings of 4 or higher (indicating the positive outcome) across the sub-scale item(s) at initial and discharge time points.

#the first report out will use a ridgeline plot to visualize across the different versions (caregiver self-report, caregiver report on youth, and youth self-report) as well as overall (all versions): <https://kieranhealy.org/blog/archives/2021/12/19/comparing-distributions/>

#the second report out will use a dumbbell plot to visualize across the different versions (caregiver self-report, caregiver report on youth, and youth self-report) as well as overall (all versions): <https://r-graph-gallery.com/web-dumbbell-chart-with-a-gap-column.html>

```{r}

# Required packages
library(ggplot2)
library(ggridges)
library(tidyr)
library(dplyr)
library(patchwork)
library(ggtext)

# Simulated data
set.seed(1243098)
df <- data.frame(id = 1:3000) %>%
  mutate(
    pop_a_initial = pmax(1, pmin(5, rnorm(n(), 3, 0.6))),
    pop_a_discharge = pmax(1, pmin(5, rnorm(n(), 3.4, 0.6))),
    pop_b_initial = pmax(1, pmin(5, rnorm(n(), 3, 0.6))),
    pop_b_discharge = pmax(1, pmin(5, rnorm(n(), 3.3, 0.6))),
    pop_c_initial = pmax(1, pmin(5, rnorm(n(), 3, 0.6))),
    pop_c_discharge = pmax(1, pmin(5, rnorm(n(), 3.5, 0.6))),
    pop_total_initial = pmax(1, pmin(5, rnorm(n(), 3, 0.6))),
    pop_total_discharge = pmax(1, pmin(5, rnorm(n(), 3.4, 0.6)))
  )

# Pivot to long format
df_long <- df %>%
  pivot_longer(cols = ends_with(c("initial", "discharge")),
               names_to = c("subgroup", "timepoint"),
               names_pattern = "(.*)_(.*)") 

# Rename and order subgroups
df_long$subgroup <- recode(df_long$subgroup,
                           "pop_a" = "Youth Self-Report",
                           "pop_b" = "Caregiver's Report on Youth/Child",
                           "pop_c" = "Caregiver Self-Report",
                           "pop_total" = "Total")
df_long$subgroup <- factor(df_long$subgroup, levels = c(
  "Total", "Caregiver Self-Report", "Caregiver's Report on Youth/Child", "Youth Self-Report"))
df_long$timepoint <- factor(df_long$timepoint, levels = c("initial", "discharge"))

# Mean difference table
mean_differences <- df_long %>%
  group_by(subgroup, timepoint) %>%
  summarise(mean_value = mean(value, na.rm = TRUE)) %>%
  pivot_wider(names_from = timepoint, values_from = mean_value) %>%
  mutate(Difference = discharge - initial)

gap_table <- ggplot(mean_differences, aes(x = 1, y = subgroup)) +
  geom_text(aes(label = round(Difference, 2)), size = 3, hjust = 0) +
  theme_void() +
  labs(title = "Mean Diff.\n(DC - Initial)") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 7, margin = margin(t = 8, b = -15)),
    axis.text.y = element_blank(),
    plot.margin = margin(t = 5, b = -5, l = 5, r = 5)
  ) +
  scale_y_discrete(limits = levels(df_long$subgroup))

# Ridgeline plot with top legend and no chart title
ridge_plot <- ggplot(df_long, aes(x = value, y = subgroup, fill = timepoint)) +
  geom_density_ridges(
    aes(color = timepoint),
    alpha = 0.7,
    scale = 1.2,
    rel_min_height = 0.01
  ) +
  scale_fill_manual(
    values = c("initial" = "#8A8C8E", "discharge" = "#BBDB49"),
    breaks = c("initial", "discharge"),
    labels = c("Initial", "Discharge (DC)")
  ) +
  scale_color_manual(
    values = c("initial" = "#8A8C8E", "discharge" = "#BBDB49"),
    breaks = c("initial", "discharge"),
    labels = c("Initial", "Discharge (DC)")
  ) +
  scale_x_continuous(limits = c(1, 5), breaks = 1:5) +
  labs(x = "Measure: Mental Health (1â€“5 Likert Scale)", y = NULL) +
  theme_ridges(font_family = "Arial") +
  theme(
    axis.title.x = element_text(size = 9, hjust = 0),
    axis.text.y = element_text(size = 9, hjust = 1),
    axis.text.x = element_text(size = 9),
    legend.position = "top",
    legend.title = element_blank(),
    legend.text = element_text(size = 8),
    legend.box.margin = margin(b = -5),
    plot.margin = margin(5, 5, 5, 5)
  )

# Combine with patchwork without title/subtitle
final_plot <- (ridge_plot | gap_table) +
  plot_layout(widths = c(5, 1)) +
  plot_annotation(title = NULL, subtitle = NULL)

# Display final plot
final_plot
```
