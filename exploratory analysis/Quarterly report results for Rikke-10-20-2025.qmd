---
title: "Quarterly Report Results-10-29-2025"
author: "Cristin Young"
format: 
  docx:
    page-width: 7.5
editor: visual
---

## Outcomes Data by Round

### Participants Served

**Data used**: Discharge data, which includes 338 clients that had more than one complete intervention.

**Nitty gritty cleaning**: took out DEMO data; checked to see which `client_ids` had `pre_measure_s` AND `post_measure_s` per row (i.e., had a complete intervention); left those in; filtered for `intervention_start <= "2025-09-30"`

```{r}
#| echo: false
#| warning: false
#| message: false
library(readr)
library(tidyverse)
discharge_data_filtered <- read_csv("/Users/cristin/Dropbox/Rebecca and Tristan and Cristin/EInsight Data/discharge_data_clean.csv")
discharge_data_filtered <- discharge_data_filtered %>% 
  filter(intervention_start <= "2025-09-30")
  
part_served <- table(discharge_data_filtered$funding_round)
part_served

```

### Improved outcomes

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
library(janitor)
# number of rows in discharge data 
nrow(discharge_data_filtered)

# number of rows with positive_outcomes != NA
count_pos <- nrow(discharge_data_filtered %>% filter(!is.na(positive_outcomes)))
count_pos

# table of positive outcomes 
tab <- discharge_data_filtered %>%
  tabyl(positive_outcomes) %>%               
  adorn_pct_formatting(digits = 1)
tab

# percent of positive outcomes
yes_pct <- tab %>%
  filter(positive_outcomes == "Yes") %>%
  pull(valid_percent)
```

Out of `{r} nrow(discharge_data_filtered)` rows of clients in EInsight's discharge data dashboard, `{r} count_pos` had both a pre- and post-score. Of those clients with complete intervention data in EInsight, `{r} yes_pct` had a positive outcome.

The results below show % of positive outcomes by round, once NA's are removed from the data.

**Nitty gritty**: Positive outcome was defined as \[ this needs to be confirmed with Rebecca/Steve; this is a column from EInsight and I believe is just defined as "Is the post-score lower/higher than the pre-score, based on the relevant assessment scoring metrics given to Steve's team"\].

```{r}
#| echo: false
#| warning: false
#| message: false
# table of positive outcomes by funding round
tab2 <- discharge_data_filtered %>% 
  filter(!is.na(positive_outcomes)) %>% 
  tabyl(positive_outcomes, funding_round) %>% 
  adorn_totals("row") %>% 
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 0) %>%
  adorn_ns() 
tab2
```

### Satisfaction

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
library(zoo)

# caregiver
caregiver_raw <- read_csv("/Users/cristin/Dropbox/Data/eInsight Exports/Satisfaction Survey Export/Satisfaction_survey-caregiver.csv", na = c("-", "", "NA", "N/A", "0"), col_names = FALSE) 
h1 <- unlist(caregiver_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(caregiver_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
caregiver <- caregiver_raw[-c(1, 2), ]
names(caregiver) <- new_names
caregiver <- caregiver %>%
  filter(!if_any(c(provider_id), ~ str_detect(as.character(.x), "DEMO")))

# child
child_raw <- read.csv("/Users/cristin/Dropbox/Data/eInsight Exports/Satisfaction Survey Export/Satisfaction_survey-child_13-17.csv", na = c("-", "", "NA", "N/A", "0"), header = FALSE) 
h1 <- unlist(child_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(child_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
child <- child_raw[-c(1, 2), ]
names(child) <- new_names
child <- child %>%
  filter(!if_any(c(provider_id), ~ str_detect(as.character(.x), "DEMO")))

# adult
adult_raw <- read_csv("/Users/cristin/Dropbox/Data/eInsight Exports/Satisfaction Survey Export/Satisfaction_survey-adult_18-59.csv", na = c("-", "", "NA", "N/A", "0"), col_names = FALSE)
h1 <- unlist(adult_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(adult_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
adult <- adult_raw[-c(1, 2), ]
names(adult) <- new_names
adult <- adult %>%
  filter(!if_any(c(provider_id), ~ str_detect(as.character(.x), "DEMO")))

# senior
senior_raw <- read_csv("/Users/cristin/Dropbox/Data/eInsight Exports/Satisfaction Survey Export/Satisfaction_survey-adult_60_plus.csv", na = c("-", "", "NA", "N/A", "0"), col_names = FALSE) 
h1 <- unlist(senior_raw[1, ], use.names = FALSE)           # question text row
h2 <- unlist(senior_raw[2, ], use.names = FALSE)           # subheaders
h1_ff <- na.locf(h1, na.rm = FALSE)                 # carries last non-NA to the right
h1_ff <- str_squish(h1_ff)
new_names <- ifelse(
  is.na(h1_ff) | h1_ff == "",
  h2,                                  # keep subheader only
  paste(h1_ff, h2, sep = " - ")        # combine when applicable
)
new_names <- janitor::make_clean_names(new_names)
senior <- senior_raw[-c(1, 2), ]
names(senior) <- new_names
senior <- senior %>%
  filter(!if_any(c(provider_id), ~ str_detect(as.character(.x), "DEMO")))
```

Satisfaction is defined two ways below. The first is the percent of individuals who answered question 1 as "Agree" or "Strongly Agree" on the satisfaction survey. The second definition is the percent of individuals who selected "Agree" or "Strongly Agree" on 80% or more of the questions completed.

**Nitty gritty:** There are four satisfaction surveys: Caregiver (n=`{r} nrow(caregiver)`), Child (13-17) (n=`{r} nrow(child)`), Adult (18-59) (n=`{r} nrow(adult)`), and Adult (60+) (n=`{r} nrow(senior)`). A separate data frame was made for question 1, and high satisfaction was defined as the percent of individuals who answered a 4 or 5 for question 1.

#### Question 1 Satisfaction

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
combined_q1 <- bind_rows(
  caregiver %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x1_")) %>% 
    rename(q1 = matches("^x1_")) %>% 
    mutate(source = "caregiver"),
  child %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x1_")) %>% 
    rename(q1 = matches("^x1_")) %>% 
    mutate(source = "child"),
  adult %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x1_")) %>% 
    rename(q1 = matches("^x1_")) %>% 
    mutate(source = "adult"),
  senior %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x1_")) %>% 
    rename(q1 = matches("^x1_")) %>% 
    mutate(source = "senior"))

combined_q1 <- combined_q1 %>% 
  filter(date_completed <= "2025-09-30")
```

The following is the % of high satisfaction by source:

```{r}
#| echo: false
#| warning: false
#| message: false

combined_q1 %>%
  group_by(source) %>%
  summarise(
    n_total = sum(!is.na(q12)),
    n_4_5 = sum(q12 %in% c(4, 5), na.rm = TRUE),
    pct_4_5 = round((100 * n_4_5 / n_total), 1)
  )
```

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
pct_4_5 <- combined_q1 %>%
  summarise(
    pct_4_5 = round((100 * sum(q12 %in% c(4, 5), na.rm = TRUE) / sum(!is.na(q12))), 1)
  ) %>%
  pull(pct_4_5)

pct_4_5
```

Overall, `{r} pct_4_5`% of survey respondents were highly satisfied based on question 1 answers. The following table shows high survey satisfaction by round.

```{r}
#| echo: false
#| warning: false
#| message: false
library(readxl)
library(janitor)
# reading in provider data for funding round. this doesn't have client_system_id though
provider_demo <- readxl::read_xlsx("/Users/cristin/Dropbox/Data/eInsight Exports/Admin Report Exports/2025-10-29-provider_demographics.xlsx", na = c("-", "", "NA", "N/A")) %>% 
  janitor::clean_names() %>% 
  select(provider, provider_id, provider_system_id, funding_round)

# getting funding round via discharge data because this has client_system_id
funding <- discharge_data_filtered %>% 
  select(provider, provider_id, provider_system_id, client_system_id, funding_round) %>% 
  #distinct(provider_id, provider, provider_system_id, funding_round, .keep_all = TRUE) %>% 
  filter(!is.na(funding_round))
         #!str_detect(funding_round, ","))
funding %>% filter(str_detect(funding_round, ","))

provider_unique <- provider_demo %>%
  distinct(provider_id, provider, provider_system_id, funding_round, .keep_all = TRUE) %>% 
  filter(!is.na(funding_round),
         !str_detect(funding_round, ","))

# combining all satisfaction survey data
combined_all <- bind_rows(
  caregiver %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x")) %>% 
    rename(q = matches("^x")) %>% 
    mutate(source = "caregiver"),
  child %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x")) %>% 
    rename(q = matches("^x")) %>% 
    mutate(source = "child"),
  adult %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x")) %>% 
    rename(q = matches("^x")) %>% 
    mutate(source = "adult"),
  senior %>% 
    select(provider, provider_id, provider_system_id, client_system_id, collection, cps_id, 
           date_completed, matches("^x")) %>% 
    rename(q = matches("^x")) %>% 
    mutate(source = "senior"))
combined_all <- combined_all %>% 
  filter(date_completed <= "2025-09-30") 

# get funding round data
# can't figure out what to join to for SSOT on funding round data 
combined_round <- combined_all %>% 
  left_join(funding %>%  
              mutate(provider_system_id = as.character(provider_system_id),
                     client_system_id = as.character(client_system_id)),
            by = c("provider", "provider_id", "provider_system_id", "client_system_id")) %>% 
  distinct(cps_id, date_completed, .keep_all = TRUE) 

# Question 1 satisfaction by round
pct_4_5_round <- combined_round %>% 
  filter(!is.na(funding_round)) %>% 
  group_by(funding_round) %>% 
  summarise(
    pct_4_5 = round((100 * sum(q2 %in% c(4, 5), na.rm = TRUE) / sum(!is.na(q2))), 1)
  )

pct_4_5_round 
```

#### Combined Survey Satisfaction

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false

summary_agree <- combined_all %>%
  # keep only question columns
  select(q2, q4, q6, q8, q10, q12, q14, q16, q18, q20, q22, q24, q26, q28, q30) %>%
  mutate(across(everything(), ~ as.numeric(.))) 

df2 <- summary_agree %>% 
  mutate(across(everything(), ~ na_if(., 0))) %>% 
  # calculate per-person proportion of "Agree"/"Strongly Agree"
  rowwise() %>%
  summarise(
    n_answered = sum(!is.na(c_across(everything()))),
    n_agree = sum(c_across(everything()) %in% c(4,5), na.rm = TRUE),
    pct_agree = n_agree / n_answered
  ) %>%
  ungroup() %>% 
  summarise(
    n_total = n(),
    n_meeting_80pct = sum(pct_agree >= 0.8, na.rm = TRUE),
    pct_meeting_80pct = round((100 * n_meeting_80pct / n_total), 1)
  )

df2

# CONFIRMED THIS WORKS THE SAME AS ABOVE
df3 <- summary_agree %>%   
  mutate(across(everything(), ~ na_if(., 0))) %>% 
  rowwise() %>% 
  mutate(count_4 = sum(c(q2, q4, q6, q8, q10, q12, q14, q16, q18, q20, q22, q24, q26, q28, q30) == "4", na.rm = TRUE), 
         count_5 = sum(c(q2, q4, q6, q8, q10, q12, q14, q16, q18, q20, q22, q24, q26, q28, q30) == "5", na.rm = TRUE),
         n_4_5 = sum(c(count_4, count_5), na.rm = TRUE),
         n_total = sum(!is.na(c_across(starts_with("q")))),
         perc_4_5 = n_4_5 / n_total
         ) %>% 
  ungroup() 

df4 <- df3 %>% 
  summarise(
    n_total = n(),
    n_meeting_80pct = sum(perc_4_5 >= 0.8, na.rm = TRUE),
    pct_meeting_80pct = round((100 * n_meeting_80pct / n_total), 1)
  )

df4
```

Overall, `{r} df4$pct_meeting_80pct`% of survey respondents were highly satisfied, defined as selecting "Agree" or "Strongly Agree" on 80% or more of the questions completed, for those who completed a survey on or before September 30, 2025.

The following table shows high survey satisfaction results by funding round, for data where both client_id and `funding_round` were available.

```{r}
#| echo: false
#| warning: false
#| message: false
summary_agree_round <- combined_round %>%
  group_by(funding_round) %>% 
  filter(!is.na(funding_round)) %>% 
  # keep only question columns
  select(q2, q4, q6, q8, q10, q12, q14, q16, q18, q20, q22, q24, q26, q28, q30) %>%
  mutate(across(everything(), ~ as.numeric(.))) %>% 
  # calculate per-person proportion of "Agree"/"Strongly Agree"
  rowwise() %>%
  summarise(
    n_answered = sum(!is.na(c_across(everything()))),
    n_agree = sum(c_across(everything()) %in% c(4, 5)),
    pct_agree = n_agree / n_answered
  ) %>%
  summarise(
    n_total = n(),
    n_meeting_80pct = sum(pct_agree >= 0.8, na.rm = TRUE),
    pct_meeting_80pct = round((100 * n_meeting_80pct / n_total), 1)
  )

summary_agree_round

# q_cols <- paste0("q", c(2,4,6,8,10,12,14))
# 
# by_round <- combined_round %>%
#   # ensure numeric just in case
#   select(q2, q4, q6, q8, q10, q12, q14, funding_round) %>% 
#   mutate(across(all_of(q_cols), ~ as.numeric(.))) %>%
#   rowwise() %>%
#   mutate(
#     n_answered = sum(!is.na(c_across(all_of(q_cols)))),
#     n_45       = sum(c_across(all_of(q_cols)) >= 4, na.rm = TRUE),
#     needed     = ceiling(0.80 * n_answered),           # ≥80% threshold
#     high_sat   = n_answered > 0 & n_45 >= needed
#   ) %>%
#   ungroup() %>%
#   group_by(funding_round) %>%
#   summarise(
#     n_resp        = sum(n_answered > 0),               # respondents with ≥1 answer
#     n_high_sat    = sum(high_sat),
#     pct_high_sat  = round(100 * n_high_sat / n_resp, 1)
#   )
# 
# by_round
```

### Successful discharges

```{r}
#| echo: false
#| warning: false
#| message: false
#| include: false
# number of rows with a reason for discharge
count_rows <- nrow(discharge_data_filtered %>% filter(!is.na(reason_for_discharge)))

# number of rows with successful discharge
# table of positive outcomes 
tab3 <- discharge_data_filtered %>%
  tabyl(reason_for_discharge) %>%               
  adorn_pct_formatting(digits = 0)
tab3

# count of successful discharge
yes_count <- tab3 %>%
  filter(reason_for_discharge == "Mutually agreed cessation of treatment (Successful Completion)") %>%
  pull(n)
yes_count

# percent of successful discharge
yes_pct3 <- tab3 %>%
  filter(reason_for_discharge == "Mutually agreed cessation of treatment (Successful Completion)") %>%
  pull(valid_percent)
yes_pct3
```

Successful discharges were defined as those clients that had "Mutually agreed cessation of treatment (Successful Completion)" as the `reason_for_discharge` in the discharge data from EInsight. Of `{r} nrow(discharge_data_filtered)` rows of discharge data, `{r} count_rows` rows had a reason for discharge stated. Of individuals with a reason for discharge stated, `{r} yes_count` (`{r} yes_pct3`) were successfully discharged.

The results below show % of successful discharges by round, once NA's are removed from the data.

```{r}
#| echo: false
#| warning: false
#| message: false
# total table of successful discharges by funding round
tab4 <- discharge_data_filtered %>% 
  filter(!is.na(reason_for_discharge)) %>% 
  tabyl(reason_for_discharge, funding_round) %>% 
  adorn_totals("row") %>% 
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 0) %>%
  adorn_ns() 
tab4
```

## Final table

|  |  |  |  |  |  |  |  |
|----|----|----|----|----|----|----|----|
| Round | Theme | Participants Served | Improved Outcomes | Satisfaction - Q1 | Satisfaction - Overall | Successful Discharges | Quote |
| 1 | Parent/Caregivers Programs and Practices | `{r} part_served[1]` | `{r} tab2[["1"]][2]` | `{r} pct_4_5_round[["pct_4_5"]][1]` | `{r} summary_agree_round$pct_meeting_80pct[1]` | `{r} tab4[["1"]][3]` |  |
| 2 | Trauma-Informed Programs and Practices | `{r} part_served[2]` | `{r} tab2[["2"]][2]` | `{r} pct_4_5_round$pct_4_5[2]` | `{r} summary_agree_round$pct_meeting_80pct[2]` | `{r} tab4[["2"]][3]` |  |
| 3 | Early Childhood Wraparound Services | `{r} part_served[3]` | `{r} tab2[["3"]][2]` | `{r} pct_4_5_round$pct_4_5[3]` | `{r} summary_agree_round$pct_meeting_80pct[3]` | `{r} tab4[["3"]][3]` |  |
| 4 | Youth-Driven Programs | `{r} part_served[4]` | `{r} tab2[["4"]][2]` | `{r} pct_4_5_round$pct_4_5[4]` | `{r} summary_agree_round$pct_meeting_80pct[4]` | `{r} tab4[["4"]][3]` |  |
| 5 | Early Intervention Programs and Practices | `{r} part_served[5]` | `{r} tab2[["5"]][2]` | `{r} pct_4_5_round$pct_4_5[5]` | `{r} summary_agree_round$pct_meeting_80pct[5]` | `{r} tab4[["5"]][3]` |  |
| 6 | No funding round selected | `{r} part_served[6]` | `{r} tab2[["No Funding Round Selected"]][2]` | `{r} pct_4_5_round$pct_4_5[6]` | `{r} summary_agree_round$pct_meeting_80pct[6]` | `{r} tab4[["No Funding Round Selected"]][3]` |  |
